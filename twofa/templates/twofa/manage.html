{% extends 'back/master.html' %}

{% block title %}Manage Two-Factor Authentication{% endblock %}

{% block mainblock %}
<div class="row">
    <div class="col-md-10 col-md-offset-1">
        <div class="block">
            <div class="block-title">
                <h2><i class="fa fa-shield"></i> <strong>Manage</strong> Two-Factor Authentication</h2>
            </div>

            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}

            <div class="row">
                <!-- Status Section -->
                <div class="col-md-6">
                    <div class="block">
                        <div class="block-title">
                            <h3><i class="fa fa-info-circle"></i> Status</h3>
                        </div>
                        
                        <table class="table table-bordered">
                            <tr>
                                <th width="40%">2FA Status:</th>
                                <td>
                                    {% if twofa.is_enabled %}
                                        <span class="label label-success"><i class="fa fa-check"></i> Enabled</span>
                                    {% else %}
                                        <span class="label label-danger"><i class="fa fa-times"></i> Disabled</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Backup Codes:</th>
                                <td>{{ backup_codes_count }} available</td>
                            </tr>
                            <tr>
                                <th>Setup Date:</th>
                                <td>{{ twofa.created_at|date:"Y-m-d H:i" }}</td>
                            </tr>
                            <tr>
                                <th>Last Used:</th>
                                <td>
                                    {% if twofa.last_used %}
                                        {{ twofa.last_used|date:"Y-m-d H:i" }}
                                    {% else %}
                                        Never
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Actions Section -->
                <div class="col-md-6">
                    <div class="block">
                        <div class="block-title">
                            <h3><i class="fa fa-cogs"></i> Actions</h3>
                        </div>
                        
                        {% if twofa.is_enabled %}
                            <!-- Regenerate Backup Codes -->
                            <div class="alert alert-info">
                                <strong>Regenerate Backup Codes</strong>
                                <p>Generate a new set of backup codes. This will invalidate all previous codes.</p>
                                <form method="post" style="margin: 0;">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="regenerate_backup">
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fa fa-refresh"></i> Regenerate Backup Codes
                                    </button>
                                </form>
                            </div>

                            <!-- Disable 2FA -->
                            <div class="alert alert-danger">
                                <strong>Disable Two-Factor Authentication</strong>
                                <p>Enter your current 2FA code to disable:</p>
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="disable">
                                    <div class="form-group">
                                        <input type="text" name="code" class="form-control" placeholder="000000" maxlength="6" pattern="[0-9]{6}" required>
                                    </div>
                                    <button type="submit" class="btn btn-danger">
                                        <i class="fa fa-times"></i> Disable 2FA
                                    </button>
                                </form>
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <strong>2FA is Currently Disabled</strong>
                                <p>Enable two-factor authentication for better security.</p>
                                <a href="{% url 'twofa_setup' %}" class="btn btn-success">
                                    <i class="fa fa-shield"></i> Enable Two-Factor Authentication
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="row" style="margin-top: 20px;">
                <div class="col-md-12">
                    <div class="block">
                        <div class="block-title">
                            <h3><i class="fa fa-history"></i> Recent Activity</h3>
                        </div>
                        
                        {% if recent_logs %}
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>Date & Time</th>
                                        <th>Method</th>
                                        <th>Status</th>
                                        <th>IP Address</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in recent_logs %}
                                    <tr>
                                        <td>{{ log.timestamp|date:"Y-m-d H:i:s" }}</td>
                                        <td>
                                            {% if log.method == 'totp' %}
                                                <i class="fa fa-mobile"></i> TOTP Code
                                            {% else %}
                                                <i class="fa fa-key"></i> Backup Code
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if log.success %}
                                                <span class="label label-success"><i class="fa fa-check"></i> Success</span>
                                            {% else %}
                                                <span class="label label-danger"><i class="fa fa-times"></i> Failed</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ log.ip_address|default:"Unknown" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p class="text-muted">No activity recorded yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
